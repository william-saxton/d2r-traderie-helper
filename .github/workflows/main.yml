name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-wails:
    name: Build Wails App (Windows)
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true
          cache-dependency-path: d2r-traderie-wails/go.sum

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: d2r-traderie-wails/frontend/package-lock.json

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build Wails App
        shell: pwsh
        run: |
          cd d2r-traderie-wails
          wails build -platform windows/amd64 -nsis

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wails-windows-amd64
          path: d2r-traderie-wails/build/bin/*

  pack-extension:
    name: Pack Browser Extension
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Zip Extension
        run: |
          cd browser-extension
          zip -r ../traderie-d2r-assistant-extension.zip . -x "*.git*" "README.md"

      - name: Upload Extension Artifact
        uses: actions/upload-artifact@v4
        with:
          name: browser-extension-zip
          path: traderie-d2r-assistant-extension.zip

  create-release:
    name: Create GitHub Release
    needs: [build-wails, pack-extension]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare Release Assets
        run: |
          mkdir release
          # Copy everything from wails-windows-amd64 artifact (installer and exe)
          cp artifacts/wails-windows-amd64/* release/
          # Copy the extension zip
          cp artifacts/browser-extension-zip/*.zip release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/*
          generate_release_notes: true
          draft: false
          prerelease: false
